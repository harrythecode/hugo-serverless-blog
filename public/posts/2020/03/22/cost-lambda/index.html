<!DOCTYPE html>
<html lang="en"><meta charset="utf-8"><meta name="generator" content="Hugo 0.68.3" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="light dark">
<meta name="supported-color-schemes" content="light dark"><title>AWSã®ã‚³ã‚¹ãƒˆã‚’Slackã«é€šçŸ¥ã™ã‚‹ã€Lambda - (4)Lambdaå®Ÿè£…ç·¨ã€‘&nbsp;&ndash;&nbsp;ã‚µãƒ¼ãƒãƒ¬ã‚¹ãƒ–ãƒ­ã‚°</title><link rel="stylesheet" href="/css/core.min.eeb34cdc9585c78a18c67ded84862021d4debb2514af02df2c00e4526a920d92b5182f70b67d9c75a35111653afc5932.css" integrity="sha384-7rNM3JWFx4oYxn3thIYgIdTeuyUUrwLfLADkUmqSDZK1GC9wtn2cdaNREWU6/Fky"><body>
    <div class="base-body"><section id="header" class="site header">
    <div class="header wrap"><span class="header left-side"><a class="site home" href="/"><span class="site name">ã‚µãƒ¼ãƒãƒ¬ã‚¹ãƒ–ãƒ­ã‚°</span></a></span>
        <span class="header right-side"><div class="nav wrap"><nav class="nav"><a class="nav item" href="/categories/">Categories</a><a class="nav item" href="/tags/">Tags</a><a class="nav item" href="/about/">About</a></nav></div></span></div><div class="site slogan"><span class="title">ä¸–ã®ä¸­ã®ã‚¤ã‚±ã¦ã‚‹æŠ€è¡“ã‚’ç´¹ä»‹ã—ã¦ã„ãã¾ã™ã€‚</span></div></section><div id="content"><div class="article-container"><section class="article header">
    <h1 class="article title">AWSã®ã‚³ã‚¹ãƒˆã‚’Slackã«é€šçŸ¥ã™ã‚‹ã€Lambda - (4)Lambdaå®Ÿè£…ç·¨ã€‘</h1><p class="article date">2020-03-22</p></section><article class="article markdown-body"><p>æœ¬è¨˜äº‹ã¯ã€Œ<a href="https://amezou.com/posts/2020/03/22/cli-lambda/"target="_blank">AWSã®ã‚³ã‚¹ãƒˆã‚’Slackã«é€šçŸ¥ã™ã‚‹ã€Lambda - (3)Lambdaæº–å‚™ç·¨ã€‘</a>ã€ã®ç¶šãã§ã™ã€‚</p>
<p>å‰å›ã®è¨˜äº‹ã§ã¯Lambdaã§å®Ÿè¡Œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã®ç¢ºèªã‚’è¡Œã„ã¾ã—ãŸã€‚ä»Šå›ã¯å®Ÿéš›ã«ä¸‹è¨˜é€šã‚Šå®Ÿè£…ã‚’é€²ã‚ã¦ã„ãã¾ã™ã€‚</p>
<h1 id="lambdaã®æ¦‚è¦">Lambdaã®æ¦‚è¦</h1>
<ul>
<li>è¨€èª: Nodejs 12.x</li>
<li>åå‰: monitoringAwsCost</li>
<li>å®Ÿè¡ŒIAMãƒ­ãƒ¼ãƒ«: aws-cost-monitoring (<a href="https://amezou.com/posts/2020/03/21/aws-cost/"target="_blank">AWSã®ã‚³ã‚¹ãƒˆã‚’Slackã«é€šçŸ¥ã™ã‚‹ã€Lambda - (1)IAMä½œæˆç·¨ã€‘</a>ã§ä½œæˆæ¸ˆã¿)</li>
</ul>
<p>ä½•ã‹ã‚’å®Ÿè£…ã™ã‚‹å‰ã«ã¯ã€ä½•ã‚’å®Ÿç¾ã—ãŸã„ã®ã‹ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ãã¾ã—ã‚‡ã†ã€‚ã“ã†ã™ã‚‹ã“ã¨ã§å®Ÿè£…ä¸­ã«ä½™è¨ˆãªã“ã¨ã‚’è€ƒãˆãšã«ã€ãã®æŒ‡ç¤ºã«ã—ãŸãŒã£ã¦ã²ãŸã™ã‚‰ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã ã‘ã§è‰¯ããªã‚Šã¾ã™ã€‚</p>
<pre><code># Lambdaå†…ã§ã‚„ã‚ŠãŸã„ã“ã¨
# 1. STSã‚’åˆ©ç”¨ã—ã¦ç‰¹å®šã®IAMãƒ­ãƒ¼ãƒ«ã«ã‚¹ã‚¤ãƒƒãƒ
# 2. Cloudwatch Metricsã§ã‚³ã‚¹ãƒˆå–å¾—
# 3. å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’Slackã§ç¶ºéº—ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
# 4. Slackã«é€šçŸ¥
</code></pre><p>ä»Šå›ã¯ã€Œ<a href="https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/CloudWatch.html#getMetricData-property"target="_blank">AWS Javascript SDK - getMetricData</a>ã€ã‚’å‚è€ƒã«ã—ãªãŒã‚‰é–‹ç™ºã‚’é€²ã‚ã¾ã™ã€‚</p>
<h2 id="æº–å‚™ç·¨">æº–å‚™ç·¨</h2>
<p>ä»Šå›ã®ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆã¯ä¸‹è¨˜ã®é€šã‚Šã§ã™ã€‚</p>
<pre><code>lambda_scripts/
â”œâ”€â”€ Makefile
â”œâ”€â”€ functions
â”‚Â Â  â””â”€â”€ monitoringAwsCost
â”‚Â Â      â”œâ”€â”€ helper-functions.js
â”‚Â Â      â”œâ”€â”€ index.js
â”‚Â Â      â”œâ”€â”€ node_modules
â”‚Â Â      â””â”€â”€ package-lock.json (è‡ªå‹•ç”Ÿæˆ)
â””â”€â”€ project.json
</code></pre><ul>
<li><code>$ npm install moment</code> ã§ã€<a href="https://www.npmjs.com/package/moment"target="_blank">moment</a>ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€‚</li>
<li><code>$ npm install @slack/webhook</code> ã§ã€<a href="https://www.npmjs.com/package/@slack/webhook"target="_blank">@slack/webhook</a>ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€‚</li>
<li>Apexã‚’ä½¿ã£ã¦Lambdaã‚’ç®¡ç† <a href="https://dev.classmethod.jp/articles/how-to-manage-aws-lambda-functions-with-apex/"target="_blank">Apexã§AWS Lambdaãƒ•ã‚¡ãƒ³ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç®¡ç†ã™ã‚‹</a></li>
</ul>
<blockquote>
<p>monitoringAwsCosté…ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«å…¨ã¦(monitoringAwsCostãƒ•ã‚©ãƒ«ãƒ€ã‚’é™¤ã)ã‚’ã€ŒmonitoringAwsCost.zipã€ãƒ•ã‚¡ã‚¤ãƒ«ã«ã—ã¦ç›´æ¥Lambdaã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã€‚</p>
</blockquote>
<h2 id="ã¾ãšã¯å®Œæˆå“ã‹ã‚‰">ã¾ãšã¯å®Œæˆå“ã‹ã‚‰</h2>
<ul>
<li>helper-function.js</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">AWS</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;aws-sdk&#39;</span>)
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">sts</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">AWS</span>.<span style="color:#a6e22e">STS</span>({<span style="color:#a6e22e">region</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;us-east-1&#39;</span>});

<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">getCrossAccountCredentials</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">async</span> (<span style="color:#a6e22e">role_arn</span>) =&gt; {
  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Promise((<span style="color:#a6e22e">resolve</span>, <span style="color:#a6e22e">reject</span>) =&gt; {
    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">timestamp</span> <span style="color:#f92672">=</span> (<span style="color:#66d9ef">new</span> Date()).<span style="color:#a6e22e">getTime</span>();
    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">params</span>    <span style="color:#f92672">=</span> {
      <span style="color:#a6e22e">RoleArn</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">role_arn</span>,
      <span style="color:#a6e22e">RoleSessionName</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`aws-cost-monitoring-</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">timestamp</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>,
    };
    <span style="color:#a6e22e">sts</span>.<span style="color:#a6e22e">assumeRole</span>(<span style="color:#a6e22e">params</span>, (<span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">data</span>) =&gt; {
      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">err</span>) <span style="color:#a6e22e">reject</span>(<span style="color:#a6e22e">err</span>);
      <span style="color:#66d9ef">else</span> {
        <span style="color:#a6e22e">resolve</span>({
          <span style="color:#a6e22e">accessKeyId</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">Credentials</span>.<span style="color:#a6e22e">AccessKeyId</span>,
          <span style="color:#a6e22e">secretAccessKey</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">Credentials</span>.<span style="color:#a6e22e">SecretAccessKey</span>,
          <span style="color:#a6e22e">sessionToken</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">Credentials</span>.<span style="color:#a6e22e">SessionToken</span>,
        });
      }
    });
  });
}

<span style="color:#a6e22e">module</span>.<span style="color:#a6e22e">exports</span> <span style="color:#f92672">=</span> {
    <span style="color:#a6e22e">getCrossAccountCredentials</span>
}
</code></pre></div><ul>
<li>index.js</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#75715e">/***
</span><span style="color:#75715e"> * Enviroment Variables
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">target_date</span>   <span style="color:#f92672">=</span> <span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">TARGET_DATE</span>;   <span style="color:#75715e">// optional
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">role_arn</span>      <span style="color:#f92672">=</span> <span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">ROLE_ARN</span>;      <span style="color:#75715e">// required
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">slack_webhook</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">SLACK_WEBHOOK</span>; <span style="color:#75715e">// required
</span><span style="color:#75715e"></span>
<span style="color:#75715e">/***
</span><span style="color:#75715e"> * Load Modules
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">AWS</span>    <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;aws-sdk&#39;</span>);
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">moment</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;moment&#39;</span>);
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">helper_func</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;./helper-functions&#39;</span>);
<span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">IncomingWebhook</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;@slack/webhook&#39;</span>);

<span style="color:#75715e">/***
</span><span style="color:#75715e"> * Global Variables
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">webhook</span>   <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">IncomingWebhook</span>(<span style="color:#a6e22e">slack_webhook</span>);
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">today</span>     <span style="color:#f92672">=</span> <span style="color:#a6e22e">moment</span>(<span style="color:#a6e22e">target_date</span>).<span style="color:#a6e22e">utc</span>().<span style="color:#a6e22e">startOf</span>(<span style="color:#e6db74">&#39;day&#39;</span>)
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">tomorrow</span>  <span style="color:#f92672">=</span> <span style="color:#a6e22e">moment</span>(<span style="color:#a6e22e">today</span>).<span style="color:#a6e22e">add</span>(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;days&#39;</span>);
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">formatted_today</span>    <span style="color:#f92672">=</span> <span style="color:#a6e22e">today</span>.<span style="color:#a6e22e">toISOString</span>();
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">formatted_tomorrow</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">tomorrow</span>.<span style="color:#a6e22e">toISOString</span>();

<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">formatted_today</span>, <span style="color:#a6e22e">formatted_tomorrow</span>);

<span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">handle</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">async</span> <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">event</span>) {
    <span style="color:#75715e">// What to do?
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 1. Switch role to a specific IAM role via STS
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// Cloudwatch data is only in the us-east-1 region.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">accessparams</span>     <span style="color:#f92672">=</span> <span style="color:#a6e22e">await</span> <span style="color:#a6e22e">helper_func</span>.<span style="color:#a6e22e">getCrossAccountCredentials</span>(<span style="color:#a6e22e">role_arn</span>);
    <span style="color:#a6e22e">accessparams</span>[<span style="color:#e6db74">&#34;region&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;us-east-1&#39;</span>;

    <span style="color:#75715e">// Assuming the new role will return temporary credentials
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">cloudwatch_client</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">AWS</span>.<span style="color:#a6e22e">CloudWatch</span>(<span style="color:#a6e22e">accessparams</span>);

    <span style="color:#75715e">// 2. Pull Cost Data from Cloudwatch Metrics
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// Define parameters
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">cw_params</span> <span style="color:#f92672">=</span> {
      <span style="color:#a6e22e">MetricDataQueries</span><span style="color:#f92672">:</span> [
        {
          <span style="color:#a6e22e">Id</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;monitoringAwsCostPerDay&#39;</span>,
          <span style="color:#a6e22e">MetricStat</span><span style="color:#f92672">:</span> {
            <span style="color:#a6e22e">Metric</span><span style="color:#f92672">:</span> {
              <span style="color:#a6e22e">Namespace</span>  <span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;AWS/Billing&#39;</span>,
              <span style="color:#a6e22e">MetricName</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;EstimatedCharges&#39;</span>,
              <span style="color:#a6e22e">Dimensions</span> <span style="color:#f92672">:</span> [
                {
                  <span style="color:#a6e22e">Name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;Currency&#39;</span>,
                  <span style="color:#a6e22e">Value</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;USD&#39;</span>
                }
              ]
            },
            <span style="color:#a6e22e">Period</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">86400</span>,
            <span style="color:#a6e22e">Stat</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;Maximum&#39;</span>,
          }
        },
      ],
      <span style="color:#a6e22e">StartTime</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">formatted_today</span>,
      <span style="color:#a6e22e">EndTime</span>   <span style="color:#f92672">:</span> <span style="color:#a6e22e">formatted_tomorrow</span>,
    };
    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">metric_data</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">await</span> <span style="color:#a6e22e">getMericDataFromCloudWatch</span>(<span style="color:#a6e22e">cloudwatch_client</span>, <span style="color:#a6e22e">cw_params</span>);

    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">metric_data</span>) {
      <span style="color:#75715e">// 3. Formatting for Slack
</span><span style="color:#75715e"></span>      <span style="color:#75715e">// 4. Send Slack
</span><span style="color:#75715e"></span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">usd_cost</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">metric_data</span>.<span style="color:#a6e22e">MetricDataResults</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">Values</span>[<span style="color:#ae81ff">0</span>];

      <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">usd_cost</span>);

      <span style="color:#a6e22e">await</span> <span style="color:#a6e22e">webhook</span>.<span style="color:#a6e22e">send</span>({
          <span style="color:#a6e22e">text</span>    <span style="color:#f92672">:</span> <span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">formatted_today</span><span style="color:#e6db74">}</span><span style="color:#e6db74">æ™‚ç‚¹ã®é‡‘é¡ã¯ä¸‹è¨˜ã®é€šã‚Šã§ã™ã€‚`</span>,
          <span style="color:#a6e22e">channel</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;#aws-notifications&#34;</span>,
          <span style="color:#a6e22e">attachments</span><span style="color:#f92672">:</span> [{<span style="color:#e6db74">&#34;text&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`Total Cost: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">usd_cost</span><span style="color:#e6db74">}</span><span style="color:#e6db74">$`</span>}]
      });
    }

    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
}

<span style="color:#a6e22e">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">getMericDataFromCloudWatch</span>(<span style="color:#a6e22e">cloudwatch_client</span>, <span style="color:#a6e22e">cw_params</span>) {

  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;Query: &#34;</span>, <span style="color:#a6e22e">cw_params</span>)

  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ret</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">await</span> <span style="color:#66d9ef">new</span> Promise(<span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">resolve</span>, <span style="color:#a6e22e">reject</span>) {
    <span style="color:#a6e22e">cloudwatch_client</span>.<span style="color:#a6e22e">getMetricData</span>(<span style="color:#a6e22e">cw_params</span>, <span style="color:#a6e22e">async</span> <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">result</span>) {
      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">err</span>) {
          <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">stack</span>);
          <span style="color:#a6e22e">reject</span>(<span style="color:#e6db74">&#34;Internal server error.&#34;</span>)
      } <span style="color:#66d9ef">else</span> {
          <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">result</span>);
          <span style="color:#a6e22e">resolve</span>(<span style="color:#a6e22e">result</span>)
      }})
  });

  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;Ret: &#34;</span>, <span style="color:#a6e22e">ret</span>)

  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ret</span>
}
</code></pre></div><h3 id="æ‰‹å‹•ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹éš›ã®æ³¨æ„">æ‰‹å‹•ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹éš›ã®æ³¨æ„</h3>
<ul>
<li>
<p><code>$ npm install moment</code> ã§ã€<a href="https://www.npmjs.com/package/moment"target="_blank">moment</a>ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€‚</p>
</li>
<li>
<p><code>$ npm install @slack/webhook</code> ã§ã€<a href="https://www.npmjs.com/package/@slack/webhook"target="_blank">@slack/webhook</a>ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€‚</p>
</li>
<li>
<p>monitoringAwsCosté…ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«å…¨ã¦(monitoringAwsCostãƒ•ã‚©ãƒ«ãƒ€ã‚’é™¤ã)ã‚’ã€ŒmonitoringAwsCost.zipã€ãƒ•ã‚¡ã‚¤ãƒ«ã«ã—ã¦ç›´æ¥Lambdaã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã€‚</p>
</li>
<li>
<p>ã€Œ1.ã€ã®ãƒãƒ³ãƒ‰ãƒ©åã‚’ã€Œindex.handleã€ã«å¤‰æ›´ã€‚(Apexã‚’ä½¿ã†ã¨ã“ã‚ŒãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ãªã‚‹ã¿ãŸã„ã§ã™ã€‚)
<span class="image-container"><span class="link" ><a href="/images/2020/03-22-cost-lambda-01.png" 
        target="_blank"><img class="img" src="/images/2020/03-22-cost-lambda-01.png"/></a></span><span class="caption">
            <span class="title">ä¸Šæ‰‹ãã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã‚Œã°2.ã®ã‚ˆã†ã«ãªã‚Šã¾ã™</span class="image-container-caption">
        </span>
</span></p>
</li>
<li>
<p>ç’°å¢ƒå¤‰æ•°ã«ã¯ä¸‹è¨˜ã®é€šã‚Šå€¤ã‚’å…¥åŠ›</p>
<ul>
<li>ROLE_ARN: æ¬¡ã®æ‰‹é †ã§ä½œæˆã—ãŸIAMãƒ­ãƒ¼ãƒ«ã®ARNã‚’å…¥åŠ›ğŸ‘‰<a href="https://amezou.com/posts/2020/03/21/aws-cost-sts/"target="_blank">AWSã®ã‚³ã‚¹ãƒˆã‚’Slackã«é€šçŸ¥ã™ã‚‹ã€Lambda - (2)STSç·¨ã€‘</a></li>
<li>SLACK_WEBHOOK: Slackã®Webhook URLã‚’å…¥åŠ›(å‚è€ƒæƒ…å ±ã€Œ<a href="https://qiita.com/kshibata101/items/0e13c420080a993c5d16"target="_blank">slackã®Incoming webhookãŒæ–°ã—ããªã£ã¦ã„ãŸã®ã§ã¾ã¨ã‚ã¦ã¿ãŸ</a>ã€)</li>
</ul>
</li>
</ul>
<span class="image-container"><span class="link" ><a href="/images/2020/03-22-cost-lambda-02.png" 
        target="_blank"><img class="img" src="/images/2020/03-22-cost-lambda-02.png"/></a></span>
</span>
<h1 id="ã‚³ãƒ¼ãƒ‰ã®è§£èª¬">ã‚³ãƒ¼ãƒ‰ã®è§£èª¬</h1>
<pre><code># Lambdaå†…ã§ã‚„ã‚ŠãŸã„ã“ã¨
# 1. STSã‚’åˆ©ç”¨ã—ã¦ç‰¹å®šã®IAMãƒ­ãƒ¼ãƒ«ã«ã‚¹ã‚¤ãƒƒãƒ
# 2. Cloudwatch Metricsã§ã‚³ã‚¹ãƒˆå–å¾—
# 3. å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’Slackã§ç¶ºéº—ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
# 4. Slackã«é€šçŸ¥
</code></pre><h2 id="momentã§ä»Šæ—¥ã¨æ˜¨æ—¥ã®æ—¥ä»˜ã‚’å–å¾—">Momentã§ä»Šæ—¥ã¨æ˜¨æ—¥ã®æ—¥ä»˜ã‚’å–å¾—</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#75715e">/***
</span><span style="color:#75715e"> * Global Variables
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">today</span>     <span style="color:#f92672">=</span> <span style="color:#a6e22e">moment</span>(<span style="color:#a6e22e">target_date</span>).<span style="color:#a6e22e">utc</span>().<span style="color:#a6e22e">startOf</span>(<span style="color:#e6db74">&#39;day&#39;</span>)
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">tomorrow</span>  <span style="color:#f92672">=</span> <span style="color:#a6e22e">moment</span>(<span style="color:#a6e22e">today</span>).<span style="color:#a6e22e">add</span>(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;days&#39;</span>);
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">formatted_today</span>    <span style="color:#f92672">=</span> <span style="color:#a6e22e">today</span>.<span style="color:#a6e22e">toISOString</span>();
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">formatted_tomorrow</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">tomorrow</span>.<span style="color:#a6e22e">toISOString</span>();
<span style="color:#75715e">// 2020-03-22T00:00:00.000Z 2020-03-23T00:00:00.000Z
</span></code></pre></div><blockquote>
<p>Cloudwatchã®GetMetricDataã§ã¯ã€ŒStartTime, EndTimeã€ã«ãŠã„ã¦ã€ISOStringãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€Unixæ™‚é–“åŠã³Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã¿ã‚’å—ã‘å–ã‚‹ã‚ˆã†ã§ã™ã€‚ã“ã‚ŒãŒæ„å¤–ã¨ç½ ã§ã—ãŸã€‚</p>
</blockquote>
<h2 id="1-stsã‚’åˆ©ç”¨ã—ã¦ç‰¹å®šã®iamãƒ­ãƒ¼ãƒ«ã«ã‚¹ã‚¤ãƒƒãƒ">1. STSã‚’åˆ©ç”¨ã—ã¦ç‰¹å®šã®IAMãƒ­ãƒ¼ãƒ«ã«ã‚¹ã‚¤ãƒƒãƒ</h2>
<p><a href="https://stackoverflow.com/a/55315086"target="_blank">using profile that assume role in aws-sdk (AWS JavaScript SDK)</a>ã§ã‚¯ãƒ­ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç”¨ã®STSã®æ‰‹æ³•ãŒç´¹ä»‹ã•ã‚Œã¦ãŸã®ã§æ¡ç”¨ã€‚ã‚‚ã¡ã‚ã‚“åŒä¸€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå†…ã®STSã«ã‚‚åˆ©ç”¨å¯èƒ½ã§ã™ã€‚</p>
<p>ã¨ã‚Šã‚ãˆãšã“ã®å®Ÿè£…ã¯åˆ¥ã®Lambdaã§ã‚‚ä½¿ã†ã‹ã‚‚ã—ã‚Œãªã„ã®ã§ãƒ˜ãƒ«ãƒ‘ãƒ¼æ©Ÿèƒ½ã¨ã—ã¦åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«å®šç¾©ã—ã¦ã„ã¾ã™ã€‚</p>
<h2 id="2-cloudwatch-metricsã§ã‚³ã‚¹ãƒˆå–å¾—">2. Cloudwatch Metricsã§ã‚³ã‚¹ãƒˆå–å¾—</h2>
<p>å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã€Œ<a href="https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/CloudWatch.html#getMetricData-property"target="_blank">AWS Javascript SDK - getMetricData</a>ã€ã‚’è¦‹ãªãŒã‚‰å®Ÿè£…ã—ã¾ã—ãŸã€‚Cloudwatchã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆæ™‚ã«ã€Œus-east-1ã€ã‚’å¿…ãšæŒ‡å®šã—ã¾ã—ã‚‡ã†ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#75715e">// 1. Switch role to a specific IAM role via STS
</span><span style="color:#75715e">// Cloudwatch data is only in the us-east-1 region.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">accessparams</span>     <span style="color:#f92672">=</span> <span style="color:#a6e22e">await</span> <span style="color:#a6e22e">helper_func</span>.<span style="color:#a6e22e">getCrossAccountCredentials</span>(<span style="color:#a6e22e">role_arn</span>);
<span style="color:#a6e22e">accessparams</span>[<span style="color:#e6db74">&#34;region&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;us-east-1&#39;</span>;
</code></pre></div><h2 id="3-å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’slackã§ç¶ºéº—ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ">3. å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’Slackã§ç¶ºéº—ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ</h2>
<p>å‰å›ã®<a href="https://amezou.com/posts/2020/03/22/cli-lambda/"target="_blank">AWSã®ã‚³ã‚¹ãƒˆã‚’Slackã«é€šçŸ¥ã™ã‚‹ã€Lambda - (3)Lambdaæº–å‚™ç·¨ã€‘</a>ã§Get Metric Dataã‚’å®Ÿè¡Œã—ãŸéš›ã«ã¯æ¬¡ã®ã‚ˆã†ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ãã¦ã¾ã—ãŸã€‚</p>
<ul>
<li><code>$ aws cloudwatch get-metric-data --cli-input-json file://&lt;your-path-to&gt;/test.json --region us-east-1</code></li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
    <span style="color:#f92672">&#34;MetricDataResults&#34;</span>: [
        {
            <span style="color:#f92672">&#34;Id&#34;</span>: <span style="color:#e6db74">&#34;monitoringAwsCostPerDay&#34;</span>,
            <span style="color:#f92672">&#34;Label&#34;</span>: <span style="color:#e6db74">&#34;EstimatedCharges&#34;</span>,
            <span style="color:#f92672">&#34;Timestamps&#34;</span>: [
                <span style="color:#e6db74">&#34;2020-03-22T00:00:00Z&#34;</span>
            ],
            <span style="color:#f92672">&#34;Values&#34;</span>: [
                <span style="color:#ae81ff">0.64</span>
            ],
            <span style="color:#f92672">&#34;StatusCode&#34;</span>: <span style="color:#e6db74">&#34;Complete&#34;</span>
        }
    ],
    <span style="color:#f92672">&#34;Messages&#34;</span>: []
}
</code></pre></div><p>Lambdaã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¦‹ã‚‹ã¨ã»ã¼ä¸€ç·’ã§ã™ã­ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">{
  <span style="color:#a6e22e">ResponseMetadata</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">RequestId</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;54b80e1c-2a05-4128-b47f-819fc5d5daa6&#39;</span> },
  <span style="color:#a6e22e">MetricDataResults</span><span style="color:#f92672">:</span> [
    {
      <span style="color:#a6e22e">Id</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;monitoringAwsCostPerDay&#39;</span>,
      <span style="color:#a6e22e">Label</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;EstimatedCharges&#39;</span>,
      <span style="color:#a6e22e">Timestamps</span><span style="color:#f92672">:</span> [Array],
      <span style="color:#a6e22e">Values</span><span style="color:#f92672">:</span> [Array],
      <span style="color:#a6e22e">StatusCode</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;Complete&#39;</span>,
      <span style="color:#a6e22e">Messages</span><span style="color:#f92672">:</span> []
    }
  ],
  <span style="color:#a6e22e">Messages</span><span style="color:#f92672">:</span> []
}
</code></pre></div><p>Slackã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¯ã€Œ<a href="https://api.slack.com/docs/messages/builder"target="_blank">Message Formatting</a>ã€ã§ç¢ºèªã§ãã¾ã™ã€‚é›£ã—ã„è¡¨è¨˜ã¯è¦ã‚‰ãªã„ã®ã§ç´”ç²‹ã«ä¸‹è¨˜ã®ã‚ˆã†ãªãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«ã—ã¾ã™ã€‚</p>
<pre><code>{
    &quot;text&quot;: &quot;XXXæ—¥ã®è«‹æ±‚é‡‘é¡&quot;,
    &quot;attachments&quot;: [
        {
            &quot;text&quot;: &quot;0.12$&quot;
        }
    ]
}
</code></pre><h2 id="4-slackã«é€šçŸ¥">4. Slackã«é€šçŸ¥</h2>
<p>Slacké€ä¿¡éƒ¨åˆ†ã¯<a href="https://www.npmjs.com/package/@slack/webhook"target="_blank">@slack/webhook</a>ã‚’åˆ©ç”¨ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">await</span> <span style="color:#a6e22e">webhook</span>.<span style="color:#a6e22e">send</span>({
    <span style="color:#a6e22e">text</span>    <span style="color:#f92672">:</span> <span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">formatted_today</span><span style="color:#e6db74">}</span><span style="color:#e6db74">æ™‚ç‚¹ã®é‡‘é¡ã¯ä¸‹è¨˜ã®é€šã‚Šã§ã™ã€‚`</span>,
    <span style="color:#a6e22e">channel</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;#aws-notifications&#34;</span>,
    <span style="color:#a6e22e">attachments</span><span style="color:#f92672">:</span> [{<span style="color:#e6db74">&#34;text&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`Total Cost: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">usd_cost</span><span style="color:#e6db74">}</span><span style="color:#e6db74">$`</span>}]
});
</code></pre></div><p>Webhook URLã®å–å¾—ã¯ã€Œ<a href="https://qiita.com/kshibata101/items/0e13c420080a993c5d16"target="_blank">slackã®Incoming webhookãŒæ–°ã—ããªã£ã¦ã„ãŸã®ã§ã¾ã¨ã‚ã¦ã¿ãŸ</a>ã€ãŒè©³ã—ã„ã§ã™ã€‚</p>
<h2 id="å®Ÿéš›ã«è©¦ã—ã¦ã¿ã‚‹">å®Ÿéš›ã«è©¦ã—ã¦ã¿ã‚‹</h2>
<p>ãã¡ã‚“ã¨å±Šã„ã¦ã¾ã™ã­ï¼
<span class="image-container"><span class="link" ><a href="/images/2020/03-22-cost-lambda-03.png" 
        target="_blank"><img class="img" src="/images/2020/03-22-cost-lambda-03.png"/></a></span>
</span></p>
<p>ã‚ã¨ã¯ã“ã‚Œã‚’å®šæœŸå®Ÿè¡Œã•ã›ã‚Œã°è‰¯ã„ã§ã™ã­ã€‚</p>
</article><section class="article labels"><a class="category" href=/categories/aws/>AWS</a><a class="category" href=/categories/%E3%82%B5%E3%83%BC%E3%83%90%E3%83%AC%E3%82%B9%E6%8A%80%E8%A1%93/>ã‚µãƒ¼ãƒãƒ¬ã‚¹æŠ€è¡“</a><a class="tag" href=/tags/aws/>aws</a><a class="tag" href=/tags/lambda/>lambda</a><a class="tag" href=/tags/sns/>sns</a><a class="tag" href=/tags/cloudwatch/>cloudwatch</a></section><section class="article license">(C) 2020, All Rights Reserved.</section></div><section class="article navigation"><p><a class="link" href="/posts/2020/03/23/vagrant/"><span class="li">&larr;</span>Vagrantã§é–‹ç™ºç’°å¢ƒã‚’ä½œã‚ã†ï¼</a></p><p><a class="link" href="/posts/2020/03/22/cli-lambda/"><span class="li">&rarr;</span>AWSã®ã‚³ã‚¹ãƒˆã‚’Slackã«é€šçŸ¥ã™ã‚‹ã€Lambda - (3)Lambdaæº–å‚™ç·¨ã€‘</a></p></section></div><section id="footer" class="footer"><div class="footer-wrap">
    <p class="copyright">ã‚µãƒ¼ãƒãƒ¬ã‚¹ãƒ–ãƒ­ã‚°</p>
    <p class="powerby"><span>Powered by </span><a href="https://gohugo.io" 
        target="_blank">Hugo</a><span> and the </span><a href="https://themes.gohugo.io/hugo-notepadium/" 
        target="_blank">Notepadium</a></p>
</div></section></div>
</body>

</html>